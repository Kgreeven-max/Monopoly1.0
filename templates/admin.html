<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi-nopoly Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <div class="container mt-4">
        <header class="mb-4">
            <h1>Pi-nopoly Admin</h1>
            <p>Manage your game settings and monitor players</p>
        </header>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab" aria-controls="players" aria-selected="false">Players</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties" type="button" role="tab" aria-controls="properties" aria-selected="false">Properties</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="bots-tab" data-bs-toggle="tab" data-bs-target="#bots" type="button" role="tab" aria-controls="bots" aria-selected="false">Bots</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab" aria-controls="finance" aria-selected="false">Finance</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="economy-tab" data-bs-toggle="tab" data-bs-target="#economy" type="button" role="tab" aria-controls="economy" aria-selected="false">Economy</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="game-modes-tab" data-bs-toggle="tab" data-bs-target="#game-modes" type="button" role="tab" aria-controls="game-modes" aria-selected="false">Game Modes</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="remote-play-tab" data-bs-toggle="tab" data-bs-target="#remote-play" type="button" role="tab" aria-controls="remote-play" aria-selected="false">Remote Play</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="adminTabsContent">
                            <!-- Dashboard Tab -->
                            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                <h2>Game Dashboard</h2>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title">Game Status</h5>
                                                <p class="card-text">Current Status: <span id="game-status">Initializing</span></p>
                                                <button class="btn btn-primary" onclick="startGame()" disabled>Start Game</button>
                                                <button class="btn btn-warning" onclick="pauseGame()">Pause Game</button>
                                                <button class="btn btn-danger" onclick="resetGame()">Reset Game</button>
                                                <small class="d-block mt-2 text-muted">Game can only be started when its status is 'Waiting'.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title">Player Stats</h5>
                                                <p>Active Players: <span id="active-players-count">0</span></p>
                                                <p>Total Money in Game: $<span id="total-money">0</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title">System Info</h5>
                                                <p>Server Uptime: <span id="server-uptime">Unknown</span></p>
                                                <p>Player Connections: <span id="player-connections">0</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Game Settings Tab -->
                            <div class="tab-pane fade" id="game-settings" role="tabpanel" aria-labelledby="game-settings-tab">
                                <h2>Game Settings</h2>
                                <form id="game-settings-form">
                                    <div class="mb-3">
                                        <label for="starting-money" class="form-label">Starting Money</label>
                                        <input type="number" class="form-control" id="starting-money" value="1500">
                                    </div>
                                    <div class="mb-3">
                                        <label for="turn-timeout" class="form-label">Turn Timeout (seconds)</label>
                                        <input type="number" class="form-control" id="turn-timeout" value="60">
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="free-parking-jackpot">
                                        <label class="form-check-label" for="free-parking-jackpot">Free Parking Jackpot</label>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="salary-on-go">
                                        <label class="form-check-label" for="salary-on-go">Double Salary on GO</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                </form>
                            </div>
                            
                            <!-- Players Tab -->
                            <div class="tab-pane fade" id="players" role="tabpanel" aria-labelledby="players-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2 class="mb-0">Player Management</h2>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger me-2" type="button" onclick="resetAllPlayers()">Reset All Players</button>
                                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="fetchAllPlayers()">Refresh Player List</button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Money</th>
                                                <th>Position</th>
                                                <th>Properties</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="players-table-body">
                                            <!-- Player rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#add-player-modal">Add Player</button>
                            </div>

                            <!-- Properties Tab -->
                            <div class="tab-pane fade" id="properties" role="tabpanel" aria-labelledby="properties-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2 class="mb-0">Property Management</h2>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="fetchProperties()">Refresh Properties</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Owner</th>
                                                <th>Houses</th>
                                                <th>Hotel</th>
                                                <th>Mortgaged</th>
                                                <th>Price</th>
                                                <th>Current Rent</th>
                                                <!-- Add more columns if needed (e.g., color, type) -->
                                                <th>Actions</th> <!-- Placeholder for admin actions -->
                                            </tr>
                                        </thead>
                                        <tbody id="properties-table-body">
                                            <tr>
                                                <td colspan="10" class="text-center">Click 'Refresh Properties' to load data.</td>
                                            </tr>
                                            <!-- Property rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Bots Tab -->
                            <div class="tab-pane fade" id="bots" role="tabpanel" aria-labelledby="bots-tab">
                                <h2>Bot Management</h2>
                                <div class="row">
                                    <!-- Add Bot Form Column -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Add New Bot</h5>
                                                <form id="add-bot-form">
                                                    <div class="mb-3">
                                                        <label for="bot-name" class="form-label">Bot Name (Optional)</label>
                                                        <input type="text" class="form-control" id="bot-name" placeholder="e.g., Bot_Alpha">
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-sm-6 mb-3">
                                                            <label for="bot-type" class="form-label">Bot Type</label>
                                                            <select class="form-select" id="bot-type" required>
                                                                <!-- Options populated by JS -->
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-6 mb-3">
                                                            <label for="bot-difficulty" class="form-label">Difficulty</label>
                                                            <select class="form-select" id="bot-difficulty" required>
                                                                <!-- Options populated by JS -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="admin-pin-bot" class="form-label">Admin PIN</label>
                                                        <input type="password" class="form-control" id="admin-pin-bot" required placeholder="Enter Admin PIN">
                                                    </div>
                                                    <button type="submit" class="btn btn-success">Add Bot</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Active Bots List Column -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h5 class="card-title mb-0">Active Bots</h5>
                                                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="fetchActiveBots()">Refresh List</button>
                                                </div>
                                                <div id="active-bots-list">
                                                    <p>Enter Admin PIN above and click Refresh List.</p>
                                                    <!-- Bot list will be populated dynamically here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Finance Tab -->
                            <div class="tab-pane fade" id="finance" role="tabpanel" aria-labelledby="finance-tab">
                                <h2>Financial Management</h2>
                                
                                <!-- Financial Overview Section -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">Financial Overview</h5>
                                            </div>
                                            <div class="card-body" id="finance-stats">
                                                <div class="d-flex justify-content-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">Interest Rates</h5>
                                            </div>
                                            <div class="card-body" id="interest-rates">
                                                <div class="d-flex justify-content-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Financial Controls Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">Actions</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-outline-primary" onclick="initializeFinanceTab()">
                                                        <i class="bi bi-arrow-repeat"></i> Refresh All Data
                                                    </button>
                                                    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#adjust-player-money-modal">
                                                        <i class="bi bi-cash"></i> Adjust Player Money
                                                    </button>
                                                    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#create-loan-modal">
                                                        <i class="bi bi-bank"></i> Create Loan
                                                    </button>
                                                    <button class="btn btn-outline-warning" onclick="triggerBankAudit()">
                                                        <i class="bi bi-shield-check"></i> Audit System
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Loans Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">Active Loans</h5>
                                                <button class="btn btn-sm btn-light" onclick="refreshLoans()">
                                                    <i class="bi bi-arrow-repeat"></i> Refresh
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Player</th>
                                                                <th>Amount</th>
                                                                <th>Interest</th>
                                                                <th>Due Date</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="active-loans-table">
                                                            <tr>
                                                                <td colspan="6" class="text-center">Loading loans...</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Transactions Section -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">Recent Transactions</h5>
                                                <button class="btn btn-sm btn-light" onclick="refreshTransactions()">
                                                    <i class="bi bi-arrow-repeat"></i> Refresh
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Time</th>
                                                                <th>Type</th>
                                                                <th>From</th>
                                                                <th>To</th>
                                                                <th>Amount</th>
                                                                <th>Reason</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="transactions-table">
                                                            <tr>
                                                                <td colspan="6" class="text-center">Loading transactions...</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Economy Tab -->
                            <div class="tab-pane fade" id="economy" role="tabpanel" aria-labelledby="economy-tab">
                                <h2>Economic Cycle Management</h2>
                                <div class="row">
                                    <!-- Economic State Column -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">Current Economic State</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <strong>State:</strong> <span id="economic-state">Loading...</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>Inflation Rate:</strong> <span id="inflation-rate">Loading...</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>Base Interest Rate:</strong> <span id="interest-rate">Loading...</span>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>Cycle Position:</strong> 
                                                    <div class="progress">
                                                        <div id="cycle-position-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                    </div>
                                                </div>
                                                <button id="refresh-economy-btn" class="btn btn-outline-secondary">Refresh</button>
                                                <button id="update-now-btn" class="btn btn-primary">Update Now</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Economic Controls Column -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">Economic Controls</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="economic-state-select" class="form-label">Force Economic State</label>
                                                    <select class="form-select" id="economic-state-select">
                                                        <option value="recession">Recession</option>
                                                        <option value="normal">Normal</option>
                                                        <option value="growth">Growth</option>
                                                        <option value="boom">Boom</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <button id="force-state-btn" class="btn btn-warning">Force State</button>
                                                </div>
                                                <hr>
                                                <div class="mb-3 form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="economic-cycle-toggle" checked>
                                                    <label class="form-check-label" for="economic-cycle-toggle">Economic Cycle Updates</label>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="admin-pin-economy" class="form-label">Admin PIN</label>
                                                    <input type="password" class="form-control" id="admin-pin-economy" placeholder="Enter Admin PIN">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Economic History Column -->
                                <div class="col-12 mb-3">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Economic History</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered table-hover table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Lap</th>
                                                            <th>Change</th>
                                                            <th>Inflation Factor</th>
                                                            <th>Total Cash</th>
                                                            <th>Time</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="economic-history-table">
                                                        <tr>
                                                            <td colspan="5" class="text-center">No economic phase changes recorded.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Crime Tab -->
                            <div class="tab-pane fade" id="crime" role="tabpanel" aria-labelledby="crime-tab">
                                <h2>Crime System</h2>
                                <p>Crime details and controls coming soon...</p>
                            </div>
                            
                            <!-- Remote Play Tab -->
                            {% include 'admin_remote_play.html' %}
                            
                            <!-- Game Modes Tab -->
                            {% include 'admin_game_modes.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div class="modal fade" id="add-player-modal" tabindex="-1" aria-labelledby="add-player-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-player-modal-label">Add New Player</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-player-form">
                        <div class="mb-3">
                            <label for="player-name" class="form-label">Player Name</label>
                            <input type="text" class="form-control" id="player-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="player-token" class="form-label">Token</label>
                            <select class="form-select" id="player-token" required>
                                <option value="car">Car</option>
                                <option value="ship">Ship</option>
                                <option value="hat">Hat</option>
                                <option value="shoe">Shoe</option>
                                <option value="dog">Dog</option>
                                <option value="cat">Cat</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="player-is-bot">
                            <label class="form-check-label" for="player-is-bot">AI Player</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addPlayer()">Add Player</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Adjust Player Money Modal -->
    <div class="modal fade" id="adjust-player-money-modal" tabindex="-1" aria-labelledby="adjust-player-money-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjust-player-money-modal-label">Adjust Player Money</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adjust-player-money-form">
                        <div class="mb-3">
                            <label for="player-id-money" class="form-label">Select Player</label>
                            <select class="form-select" id="player-id-money" required>
                                <option value="">-- Select Player --</option>
                                <!-- Populated dynamically when modal opens -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="money-adjustment-amount" class="form-label">Adjustment Amount ($)</label>
                            <input type="number" class="form-control" id="money-adjustment-amount" required>
                            <div class="form-text">Use positive value to add money, negative to subtract.</div>
                        </div>
                        <div class="mb-3">
                            <label for="money-adjustment-reason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="money-adjustment-reason" placeholder="e.g., Bank error in your favor" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitAdjustPlayerMoney()">Adjust Money</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manage Community Fund Modal -->
    <div class="modal fade" id="manage-community-fund-modal" tabindex="-1" aria-labelledby="manage-community-fund-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manage-community-fund-modal-label">Manage Community Fund</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="manage-community-fund-form">
                        <div class="mb-3">
                            <label for="community-fund-balance" class="form-label">Current Balance</label>
                            <input type="text" class="form-control" id="community-fund-balance" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="community-fund-adjustment" class="form-label">Adjustment Amount ($)</label>
                            <input type="number" class="form-control" id="community-fund-adjustment" required>
                            <div class="form-text">Use positive value to add money, negative to subtract.</div>
                        </div>
                        <div class="mb-3">
                            <label for="community-fund-reason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="community-fund-reason" placeholder="e.g., Luxury tax" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCommunityFundAdjustment()">Submit Adjustment</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Loan Modal -->
    <div class="modal fade" id="create-loan-modal" tabindex="-1" aria-labelledby="create-loan-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="create-loan-modal-label">Create Loan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-loan-form">
                        <div class="mb-3">
                            <label for="loan-player-id" class="form-label">Select Player</label>
                            <select class="form-select" id="loan-player-id" required>
                                <option value="">-- Select Player --</option>
                                <!-- Populated dynamically when modal opens -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="loan-type" class="form-label">Loan Type</label>
                            <select class="form-select" id="loan-type" required>
                                <option value="standard">Standard Loan</option>
                                <option value="cd">Certificate of Deposit (CD)</option>
                                <option value="heloc">Home Equity Line of Credit (HELOC)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="loan-amount" class="form-label">Amount ($)</label>
                            <input type="number" class="form-control" id="loan-amount" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="loan-interest-rate" class="form-label">Interest Rate (%)</label>
                            <input type="number" class="form-control" id="loan-interest-rate" step="0.1" min="0" max="100" required>
                            <div class="form-text">Standard rate based on current economic conditions.</div>
                        </div>
                        <div class="mb-3">
                            <label for="loan-term" class="form-label">Term (Rounds/Laps)</label>
                            <input type="number" class="form-control" id="loan-term" required min="1" max="20">
                            <div class="form-text">Number of game rounds until maturity or full payment required.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateLoan()">Create Loan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/remote-play-admin.js') }}"></script>
    <script>
        // Store admin key in a global variable for use by modules
        window.adminKey = "{{ admin_key }}";
        
        // Connect to Socket.IO
        const socket = io({
            query: {
                admin_pin: window.adminKey,
                client: 'admin'
            },
            path: "/ws/socket.io"
        });
        
        // Store socket in a global variable for use by modules
        window.socket = socket;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Add debug to verify tabs are initialized
            console.log('DOM Content Loaded - checking tab elements');
            const tabElements = document.querySelectorAll('[role="tab"]');
            console.log(`Found ${tabElements.length} tab elements`);
            tabElements.forEach(el => console.log(`Tab: ${el.id}, Target: ${el.getAttribute('data-bs-target')}`));
            
            // Initialize admin functionality
            // ... (admin initialization code) ...
            
            // Display admin key for debugging
            console.log('Admin initialized with key:', window.adminKey);
            console.log('Admin key length:', window.adminKey.length);

            // Fetch initial game state
            fetchGameState();

            // Fetch and populate bot options
            fetchBotOptions(); 
            
            // Add event listener for the bot form
            const addBotForm = document.getElementById('add-bot-form');
            if (addBotForm) {
                addBotForm.addEventListener('submit', handleAddBotSubmit);
            }
            
            // Listen for bot created/removed events to update list (placeholder)
            socket.on('bot_created', handleBotCreated);

            socket.on('bot_removed', (data) => {
                console.log('Bot removed:', data);
                // TODO: Add logic to update the active bots list UI
                alert(`Bot ${data.name} removed successfully!`);
                fetchActiveBots(); // Refresh list after removing
            });
            
            // Listen for bots_reset event 
            socket.on('bots_reset', (data) => {
                console.log('Bots reset event received:', data);
                // Clear the active bots list in the UI
                document.getElementById('active-bots-list').innerHTML = '<p>No active bots found.</p>';
                console.log('All bots have been removed during game reset');
            });

            // Listen for the bot list response
            socket.on('active_bots_list', (data) => {
                console.log('Received active_bots_list:', data);
                if (data && data.success) {
                    renderBotList(data.bots);
                } else {
                    console.error("Failed to fetch active bots list:", data ? data.error : 'Unknown error');
                    document.getElementById('active-bots-list').innerHTML = '<p class="text-danger">Error fetching bot list.</p>';
                }
            });

            // Listen for game state updates
            socket.on('game_state_update', (data) => {
                console.log('Game state update received:', data);
                if (data) {
                    // Update game status display
                    const gameStatusElement = document.getElementById('game-status');
                    if (gameStatusElement) {
                        // Map backend status values to user-friendly display values
                        const statusMap = {
                            'setup': 'Waiting',
                            'active': 'In Progress',
                            'paused': 'Paused',
                            'ended': 'Ended'
                        };
                        
                        const displayStatus = statusMap[data.status] || data.status || 'Unknown';
                        gameStatusElement.textContent = displayStatus;
                        
                        // Enable/disable start button based on game status
                        const startButton = document.querySelector('button[onclick="startGame()"]');
                        if (startButton) {
                            startButton.disabled = data.status !== 'setup';
                        }
                    }
                }
            });

            // Listen for errors related to bot actions
            socket.on('auth_error', (data) => {
                if (data && data.error) {
                    console.error('Auth Error:', data.error);
                    alert(`Authentication Error: ${data.error}`);
                }
            });
            socket.on('event_error', (data) => { // Assuming bot errors use 'event_error'
                if (data && data.error) {
                    console.error('Bot Event Error:', data.error);
                    alert(`Bot Error: ${data.error}`);
                }
            });

            // Added globally for button onclick
            window.removeBot = removeBot;
            window.fetchActiveBots = fetchActiveBots; // Expose fetch function for button
            window.fetchProperties = fetchProperties; // Expose properties fetch function
            window.fetchAllPlayers = fetchAllPlayers; // Expose players fetch function

            // Expose player management functions
            window.viewPlayerDetails = viewPlayerDetails;
            window.modifyPlayer = modifyPlayer;
            window.removePlayer = removePlayer;
            window.resetAllPlayers = resetAllPlayers;

            // Player action functions
            function resetAllPlayers() {
                if (confirm('Are you sure you want to reset ALL players? This will mark all players as out of the game.')) {
                    console.log('Resetting all players...');
                    
                    if (socket && adminKey) {
                        socket.emit('reset_all_players', { admin_pin: adminKey });
                        alert('Reset request sent - all players will be marked as out of game');
                        
                        // Refresh the player list after a short delay
                        setTimeout(fetchAllPlayers, 1000);
                    } else {
                        console.error('Socket or adminKey not available');
                        alert('Error: Cannot reset players - connection or authentication issue');
                    }
                }
            }
            
            function viewPlayerDetails(playerId, playerName, isBot) {
                console.log(`Viewing details for player ${playerName} (ID: ${playerId}, Is Bot: ${isBot})`);
                // Create a basic details view for now
                const playerType = isBot ? 'Bot' : 'Human';
                alert(`Player Details\n--------------\nID: ${playerId}\nName: ${playerName}\nType: ${playerType}\n\nAdditional details would be shown in a modal dialog.`);
            }

            function modifyPlayer(playerId, playerName, isBot) {
                console.log(`Modifying player ${playerName} (ID: ${playerId}, Is Bot: ${isBot})`);
                const newName = prompt(`Enter new name for ${playerName}:`, playerName);
                
                if (newName === null) return; // User cancelled
                
                if (newName !== playerName) {
                    // In a real implementation, you would make an API call here
                    alert(`Player name would be updated from "${playerName}" to "${newName}"\n\nThis is a placeholder for the API call.`);
                }
            }

            function removePlayer(playerId, playerName, isBot) {
                console.log(`Removing player ${playerName} (ID: ${playerId}, Is Bot: ${isBot})`);
                
                const confirmMessage = isBot ? 
                    `Are you sure you want to remove bot player "${playerName}"?` : 
                    `Are you sure you want to remove player "${playerName}"?`;
                    
                if (confirm(confirmMessage)) {
                    // Implementation would differ between human players and bots
                    if (isBot) {
                        if (socket && adminKey) {
                            console.log(`Sending remove_bot request for bot ID: ${playerId}`);
                            socket.emit('remove_bot', { 
                                bot_id: playerId, 
                                admin_pin: adminKey 
                            });
                            alert(`Bot removal request sent for: ${playerName}`);
                        } else {
                            alert('Socket connection not available');
                        }
                    } else {
                        // Human player removal would use a different API
                        alert(`Human player removal would be implemented here for: ${playerName}`);
                    }
                    
                    // Refresh the player list after a short delay
                    setTimeout(fetchAllPlayers, 1000);
                }
            }

            // --- Player Tab Functions ---
            function fetchAllPlayers() {
                console.log('fetchAllPlayers called - attempting to fetch all players...');
                if (socket && adminKey) {
                    console.log('Socket and adminKey available, emitting get_all_players event');
                    console.log('Using admin key:', adminKey); 
                    socket.emit('get_all_players', { admin_pin: adminKey });
                } else {
                    console.error('Socket or adminKey not available for fetching players.', { 
                        socketAvailable: !!socket, 
                        adminKeyAvailable: !!adminKey,
                        adminKeyValue: adminKey
                    });
                    showAdminAlert('Cannot fetch players: Connection or authentication issue.', 'danger');
                }
            }

            function renderPlayerList(players) {
                const playerTableBody = document.getElementById('players-table-body');
                console.log('renderPlayerList called', { 
                    playerCount: players?.length || 0,
                    playerTableBodyExists: !!playerTableBody,
                    firstPlayerId: players && players.length > 0 ? players[0].id : null
                });
                
                if (!playerTableBody) {
                    console.error('players-table-body element not found in the DOM!');
                    return;
                }
                
                playerTableBody.innerHTML = ''; // Clear existing rows

                if (!players || players.length === 0) {
                    console.log('No players found, showing empty message');
                    playerTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No players found.</td></tr>';
                    return;
                }

                players.forEach(player => {
                    const row = document.createElement('tr');
                    const status = player.in_game ? (player.in_jail ? 'Jailed' : 'Active') : 'Out'; 
                    const botBadge = player.is_bot ? ' <span class="badge bg-info">Bot</span>' : '';
                    
                    // Add visual styling for removed players/bots
                    if (!player.in_game) {
                        row.classList.add('text-muted');
                        row.style.backgroundColor = '#f8f9fa';  // Light gray background
                    }
                    
                    row.innerHTML = `
                        <td>${player.name}${botBadge} (ID: ${player.id})</td>
                        <td>$${player.money}</td>
                        <td>${player.position}</td>
                        <td>${player.properties ? player.properties.length : '0'}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewPlayerDetails(${player.id}, '${player.name}', ${player.is_bot})">Details</button>
                            <button class="btn btn-sm btn-warning me-1" onclick="modifyPlayer(${player.id}, '${player.name}', ${player.is_bot})">Modify</button>
                            <button class="btn btn-sm btn-danger" onclick="removePlayer(${player.id}, '${player.name}', ${player.is_bot})" ${!player.in_game ? 'disabled title="Already removed"' : ''}>Remove</button>
                        </td>
                    `;
                    playerTableBody.appendChild(row);
                });
            }

            // Listen for the player list response
            if (socket) {
                socket.on('all_players_list', (data) => {
                    console.log('Received all_players_list event:', data);
                    if (data.success) {
                        console.log(`Rendering ${data.players.length} players...`);
                        renderPlayerList(data.players);
                    } else {
                        console.error("Failed to fetch players:", data.error || 'Unknown error');
                        showAdminAlert(data.error || 'Failed to fetch players.', 'danger');
                        const playerTableBody = document.getElementById('players-table-body');
                        playerTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading players.</td></tr>';
                    }
                });
            }
            
            // Fetch players when the Players tab is shown
            const playersTab = document.getElementById('players-tab');
            if (playersTab) {
                 console.log('Adding shown.bs.tab event listener to players-tab');
                 playersTab.addEventListener('shown.bs.tab', function(event) {
                     console.log('Players tab clicked/shown - event triggered', event);
                     fetchAllPlayers();
                 });
            } else {
                console.error('Could not find players-tab element!');
            }
            // --- End Player Tab Functions ---
        });
        
        // Game control functions
        function startGame() {
            console.log('Attempting to start game...');
            // Remove confirmation or make it specific to starting
            // if (!confirm('Are you sure you want to start the game? ...')) { return; }
            
            fetch('/api/game/start', { // Corrected endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Add admin key header if your decorator checks headers first
                    'X-Admin-Key': window.adminKey 
                },
                body: JSON.stringify({
                    admin_pin: window.adminKey
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Game started successfully! Current Player: ' + data.current_player);
                    console.log('Game start response:', data);
                    // Rely on socket updates for state changes
                } else {
                    alert('Failed to start game: ' + (data.error || 'Unknown error'));
                    console.error('Game start failed:', data);
                }
            })
            .catch(error => {
                console.error('Error starting game:', error);
                alert('Error starting game: ' + error.message);
            });
        }
        
        function pauseGame() {
            console.log('Attempting to pause game...');
            
            // Get current game state from GameState
            fetch('/api/game/state', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(stateData => {
                if (!stateData.success) {
                    throw new Error('Failed to get game state');
                }
                
                // Determine if we need to pause or resume based on current status
                const currentStatus = stateData.game_state?.status || 'unknown';
                const action = currentStatus === 'active' ? 'pause' : 'resume';
                
                // Call the appropriate API endpoint with the fixed path
                console.log(`Using endpoint: /api/admin/game/${action}`);
                return fetch(`/api/admin/game/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': window.adminKey
                    },
                    body: JSON.stringify({
                        admin_pin: window.adminKey
                    })
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const action = data.action || (data.status === 'paused' ? 'paused' : 'resumed');
                    alert(`Game ${action} successfully`);
                    console.log('Game pause/resume response:', data);
                    // Refresh the page to update UI
                    window.location.reload();
                } else {
                    alert(`Failed to update game status: ${data.error || 'Unknown error'}`);
                    console.error('Game pause/resume failed:', data);
                }
            })
            .catch(error => {
                console.error('Error updating game status:', error);
                alert(`Error updating game status: ${error.message}`);
            });
        }
        
        // Fetch and update the game state
        function fetchGameState() {
            console.log('Fetching current game state...');
            
            fetch('/api/game/state', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Game state fetched successfully:', data);
                    
                    // Update game status display
                    const gameStatusElement = document.getElementById('game-status');
                    if (gameStatusElement) {
                        // Map backend status values to user-friendly display values
                        const statusMap = {
                            'setup': 'Waiting',
                            'active': 'In Progress',
                            'paused': 'Paused',
                            'ended': 'Ended'
                        };
                        
                        const displayStatus = statusMap[data.status] || data.status || 'Unknown';
                        gameStatusElement.textContent = displayStatus;
                        
                        // Enable/disable start button based on game status
                        const startButton = document.querySelector('button[onclick="startGame()"]');
                        if (startButton) {
                            startButton.disabled = data.status !== 'setup';
                        }
                    }
                    
                    // Update other game state information if needed
                    // For example, player count, current player, etc.
                } else {
                    console.error('Failed to fetch game state:', data.error);
                    // Don't update UI on error to avoid confusing the user
                }
            })
            .catch(error => {
                console.error('Error fetching game state:', error);
                // Don't update UI on error to avoid confusing the user
            });
        }
        
        function resetGame() {
            console.log('Attempting to reset game...');
            if (!confirm('Are you sure you want to reset the game? This will create a new game instance and initialize properties if needed.')) {
                return;
            }
            
            fetch('/api/admin/reset', { // Endpoint is already correct, no change needed
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({}) // Empty JSON body
            })
            .then(response => {
                if (!response.ok) {
                    // Try to parse error message from response body
                    return response.json().then(errData => {
                        throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        // Fallback if parsing error fails
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Game reset successfully! Game ID: ' + data.game_id + '. Properties initialized.');
                    console.log('Game reset response:', data);
                    // Refresh the admin dashboard to show updated game state
                    window.location.reload(); // Force a page reload to refresh all data
                } else {
                    alert('Failed to reset game: ' + (data.error || 'Unknown error'));
                    console.error('Game reset failed:', data);
                }
            })
            .catch(error => {
                console.error('Error resetting game:', error);
                alert('Error resetting game: ' + error.message);
            });
        }
        
        function addPlayer() {
            // Implement add player logic
        }

        // Fetch Bot Types and Difficulties
        async function fetchBotOptions() {
            try {
                // Assuming your route returns the bot types like we saw earlier
                const response = await fetch('/api/admin/bots/types', {
                    method: 'GET',
                    headers: {
                        'X-Admin-Key': window.adminKey // Add the admin key header
                    }
                }); 
                if (!response.ok) {
                    // Handle specific auth error
                    if (response.status === 401) {
                         console.error("Authorization error fetching bot options. Ensure admin key is correct or available.");
                         alert("Authorization error fetching bot configuration options.");
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return; // Stop processing if response not ok
                }
                const data = await response.json();

                if (data.success) {
                    const botTypeSelect = document.getElementById('bot-type');
                    const botDifficultySelect = document.getElementById('bot-difficulty');

                    if (botTypeSelect) {
                        botTypeSelect.innerHTML = ''; // Clear previous options if any
                        data.bot_types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.id;
                            // Shorten description for display
                            const shortDesc = type.description.length > 50 ? type.description.substring(0, 47) + '...' : type.description;
                            option.textContent = `${type.name}`; 
                            option.title = type.description; // Show full description on hover
                            botTypeSelect.appendChild(option);
                        });
                    }

                    if (botDifficultySelect) {
                        botDifficultySelect.innerHTML = ''; // Clear previous options if any
                        data.difficulty_levels.forEach(level => {
                            const option = document.createElement('option');
                            option.value = level.id;
                            option.textContent = `${level.name}`;
                            option.title = level.description; // Show full description on hover
                            botDifficultySelect.appendChild(option);
                        });
                        // Set default to medium if exists
                        if (botDifficultySelect.querySelector('option[value="medium"]')) {
                            botDifficultySelect.value = 'medium';
                        }
                    }
                } else {
                    console.error("Failed to fetch bot options:", data.error);
                    alert("Error fetching bot configuration options.");
                }
            } catch (error) {
                console.error("Error fetching bot options:", error);
                // Displaying alert might be annoying if API requires auth later
                // alert("Error fetching bot configuration options."); 
            }
        }

        // Fetch Active Bots List
        function fetchActiveBots() {
            const adminPinInput = document.getElementById('admin-pin-bot'); // Reuse PIN input for auth
            if (!adminPinInput || !adminPinInput.value) {
                // Only show alert if PIN field exists and is empty, maybe user hasn't entered it yet
                // console.warn('Admin PIN required to fetch bot list. Enter PIN in the Add Bot form.');
                // Alternatively, could add a separate PIN input just for fetching/removing if needed
                // For now, we proceed assuming PIN might be entered later or is not strictly needed for read-only list
                 console.log("Attempting to fetch bots without PIN..."); // Or prompt if required
                 socket.emit('get_active_bots', { admin_pin: window.adminKey }); // Use global admin key instead of empty string
            } else {
                console.log("Fetching active bots...");
                socket.emit('get_active_bots', { admin_pin: adminPinInput.value });
            }
        }

        // Render Active Bots List
        function renderBotList(bots) {
            const listContainer = document.getElementById('active-bots-list');
            if (!listContainer) return;

            if (!bots || bots.length === 0) {
                listContainer.innerHTML = '<div class="alert alert-info">No active bots found. All bots have been removed from the game.</div>';
                return;
            }

            // Using List Group from Bootstrap
            let listHtml = '<ul class="list-group">';
            bots.forEach(bot => {
                listHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${bot.name || 'Unnamed Bot'}</strong> (ID: ${bot.id})<br>
                            <small>Type: ${bot.bot_type || 'N/A'} | Difficulty: ${bot.difficulty || 'N/A'} | Money: $${bot.money !== undefined ? bot.money : 'N/A'}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeBot('${bot.id}')">Remove</button>
                    </li>
                `;
            });
            listHtml += '</ul>';

            listContainer.innerHTML = listHtml;
            console.log(`Rendered ${bots.length} active bots in list`);
        }

        // Remove Bot Function (Placeholder - requires PIN input)
        function removeBot(botId) {
            const adminPinInput = document.getElementById('admin-pin-bot'); // Reuse PIN from add form
            let adminPin = adminPinInput ? adminPinInput.value : null;

            if (!adminPin) {
                // Use global admin key if input is empty
                adminPin = window.adminKey;
                console.log("Using global admin key for bot removal");
            }

            if (confirm(`Are you sure you want to remove bot ID: ${botId}?`)) {
                console.log(`Attempting to remove bot ID: ${botId}`);
                socket.emit('remove_bot', { 
                    bot_id: botId, 
                    admin_pin: adminPin 
                });
            }
        }

        // Handle Add Bot Form Submission
        function handleAddBotSubmit(event) {
            event.preventDefault(); // Prevent default form submission

            const botNameInput = document.getElementById('bot-name');
            const botTypeSelect = document.getElementById('bot-type');
            const botDifficultySelect = document.getElementById('bot-difficulty');
            const adminPinInput = document.getElementById('admin-pin-bot');

            const botData = {
                admin_pin: adminPinInput.value,
                name: botNameInput.value || null, // Send null if empty, backend handles default
                type: botTypeSelect.value,
                difficulty: botDifficultySelect.value
            };
            
            if (!botData.admin_pin) {
                 alert('Admin PIN is required to add a bot.');
                 return;
            }

            console.log("Emitting create_bot with data:", botData);
            socket.emit('create_bot', botData);
        }

        function clearBotForm() {
            document.getElementById('bot-name').value = '';
            // Optionally reset selects to default or leave as is
            // document.getElementById('bot-type').value = 'conservative'; 
            // document.getElementById('bot-difficulty').value = 'medium';
            document.getElementById('admin-pin-bot').value = ''; 
        }

        // --- Property Tab Functions --- 
        async function fetchProperties() {
            const propertiesTableBody = document.getElementById('properties-table-body');
            propertiesTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Loading properties...</td></tr>';
            
            try {
                const response = await fetch('/api/admin/properties', {
                    method: 'GET',
                    headers: {
                        'X-Admin-Key': window.adminKey // Use stored admin key
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        propertiesTableBody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Authorization Error: Invalid or missing admin key.</td></tr>';
                        alert("Authorization Error fetching properties.");
                    } else {
                        propertiesTableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${response.status} ${response.statusText}</td></tr>`;
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    renderPropertyList(data.properties);
                } else {
                    propertiesTableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${data.error || 'Failed to load properties.'}</td></tr>`;
                    console.error("Failed to fetch properties:", data.error);
                }
            } catch (error) {
                propertiesTableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error loading properties: ${error.message}</td></tr>`;
                console.error("Error fetching properties:", error);
            }
        }

        function renderPropertyList(properties) {
            const propertiesTableBody = document.getElementById('properties-table-body');
            if (!propertiesTableBody) return;

            if (!properties || properties.length === 0) {
                propertiesTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No properties found.</td></tr>';
                return;
            }

            let tableHtml = '';
            properties.forEach(prop => {
                tableHtml += `
                    <tr>
                        <td>${prop.id}</td>
                        <td>${prop.name || 'N/A'}</td>
                        <td>${prop.owner_name || 'Bank'}</td>
                        <td>${prop.hotel ? '-' : prop.houses}</td>
                        <td>${prop.hotel ? 'Yes' : 'No'}</td>
                        <td>${prop.is_mortgaged ? '<span class="text-danger">Yes</span>' : 'No'}</td>
                        <td>$${prop.price !== undefined ? prop.price : 'N/A'}</td>
                        <td>$${prop.current_rent !== undefined ? prop.current_rent : 'N/A'}</td>
                        <td>
                            <!-- Placeholder for Action buttons -->
                            <button class="btn btn-xs btn-outline-primary" disabled>Manage</button> 
                        </td>
                    </tr>
                `;
            });

            propertiesTableBody.innerHTML = tableHtml;
        }
        // --- End Property Tab Functions ---

        function handleBotCreated(data) {
            console.log('Bot created:', data);
            const botList = document.getElementById('active-bots-list');
            if (botList.querySelector('.no-bots-message')) {
                botList.innerHTML = ''; // Clear 'No bots found' message
            }

            // Ensure data has expected properties before creating element
            if (data && data.bot_id && data.name) {
                const botItem = document.createElement('li');
                botItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                botItem.id = `bot-${data.bot_id}`;

                // Extract type and difficulty, provide defaults if missing
                const botType = data.type || 'unknown'; 
                const botDifficulty = data.difficulty || 'unknown';
                const botMoney = data.money !== undefined ? data.money : 'N/A';

                botItem.innerHTML = `
                    <span>
                        <strong>${data.name}</strong> (ID: ${data.bot_id}) <br>
                        <small>Type: ${capitalizeFirstLetter(botType)} | Difficulty: ${capitalizeFirstLetter(botDifficulty)} | Money: $${botMoney}</small>
                    </span>
                    <button class="btn btn-danger btn-sm" onclick="handleRemoveBot(${data.bot_id})">Remove</button>
                `;
                botList.appendChild(botItem);
                // Optionally, clear the form fields
                document.getElementById('add-bot-form').reset();
            } else {
                console.error('Received invalid data for bot_created event:', data);
                showAdminAlert('Failed to add bot to list due to invalid data.', 'danger');
            }
        }

        // Utility Functions
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Utility function to format transaction types
        function formatTransactionType(type) {
            if (!type) return 'Unknown';
            
            // Format camelCase or snake_case to Title Case
            return type
                .replace(/([A-Z])/g, ' $1') // Insert space before capital letters
                .replace(/_/g, ' ') // Replace underscores with spaces
                .replace(/^\w/, c => c.toUpperCase()); // Capitalize first letter
        }
        
        // Utility function to safely access DOM elements and handle missing elements
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with ID "${id}" not found in the DOM`);
                return null;
            }
            return element;
        }
        
        // Format financial data for display
        function loadFinancialData(data) {
            if (!data) return {};
            
            // Create a copy to avoid modifying the original
            const formattedData = {...data};
            
            // Format economic state
            if (formattedData.economic_state) {
                const state = formattedData.economic_state;
                formattedData.economic_state = state.charAt(0).toUpperCase() + state.slice(1);
            }
            
            // Format interest rates
            if (formattedData.interest_rate || formattedData.interest) {
                const rate = formattedData.interest_rate || formattedData.interest;
                const numericRate = parseFloat(rate);
                if (!isNaN(numericRate)) {
                    formattedData.formattedInterestRate = numericRate.toLocaleString(undefined, {
                        style: 'percent',
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 2
                    });
                }
            }
            
            return formattedData;
        }
        
        // --- Finance Tab Functions ---
        
        // Finance Tab - initialize tab listener
        document.addEventListener('DOMContentLoaded', function() {
            const financeTab = document.getElementById('finance-tab');
            if (financeTab) {
                console.log('Adding shown.bs.tab event listener to finance-tab');
                financeTab.addEventListener('shown.bs.tab', function(event) {
                    console.log('Finance tab clicked/shown - event triggered');
                    initializeFinanceTab();
                });
            }
            
            // Initialize modal data loading for financial operations
            const adjustPlayerMoneyModal = document.getElementById('adjust-player-money-modal');
            if (adjustPlayerMoneyModal) {
                adjustPlayerMoneyModal.addEventListener('show.bs.modal', loadPlayersForMoneyAdjustment);
            }
            
            const createLoanModal = document.getElementById('create-loan-modal');
            if (createLoanModal) {
                createLoanModal.addEventListener('show.bs.modal', loadPlayersForLoan);
            }
            
            const manageCommunityFundModal = document.getElementById('manage-community-fund-modal');
            if (manageCommunityFundModal) {
                manageCommunityFundModal.addEventListener('show.bs.modal', loadCommunityFundBalance);
            }
            
            // Add functions to global window
            window.refreshFinancialOverview = refreshFinancialOverview;
            window.updateBankSettings = updateBankSettings;
            window.triggerBankAudit = triggerBankAudit;
            window.refreshLoans = refreshLoans;
            window.refreshTransactions = refreshTransactions;
            window.submitAdjustPlayerMoney = submitAdjustPlayerMoney;
            window.adjustCommunityFund = adjustCommunityFund;
            window.submitCommunityFundAdjustment = submitCommunityFundAdjustment;
            window.submitCreateLoan = submitCreateLoan;
        });
        
        // Finance - Refresh financial overview
        function refreshFinancialOverview() {
            console.log('Loading financial overview...');
            
            fetch('/api/admin/finance/overview', {
                method: 'GET',
                headers: {
                    'X-Admin-Key': window.adminKey
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update financial stats in the UI
                    document.getElementById('total-money-game').textContent = '$' + data.stats.total_money;
                    document.getElementById('bank-reserves').textContent = '$' + data.stats.bank_reserves;
                    document.getElementById('player-holdings').textContent = '$' + data.stats.player_holdings;
                    document.getElementById('community-fund').textContent = '$' + data.stats.community_fund;
                    document.getElementById('total-active-loans').textContent = '$' + data.stats.loans_total;
                    
                    // Update interest rates
                    // First try to use formatted rates, then fall back to calculating percentages from rates
                    if (data.formatted_rates) {
                        document.getElementById('base-interest-rate').textContent = data.formatted_rates.base_interest_rate;
                        document.getElementById('loan-rate').textContent = data.formatted_rates.loan_rate;
                        document.getElementById('savings-rate').textContent = data.formatted_rates.savings_rate;
                        document.getElementById('mortgage-rate').textContent = data.formatted_rates.mortgage_rate;
                    } else if (data.rates) {
                        document.getElementById('base-interest-rate').textContent = (data.rates.base_rate * 100).toFixed(2) + '%';
                        document.getElementById('loan-rate').textContent = (data.rates.rates.loan.standard * 100).toFixed(2) + '%';
                        document.getElementById('savings-rate').textContent = (data.rates.rates.cd.medium_term * 100).toFixed(2) + '%';
                        document.getElementById('mortgage-rate').textContent = (data.rates.rates.heloc * 100).toFixed(2) + '%';
                    } else {
                        // Default values if no rates are available
                        document.getElementById('base-interest-rate').textContent = '5.00%';
                        document.getElementById('loan-rate').textContent = '6.50%';
                        document.getElementById('savings-rate').textContent = '4.00%';
                        document.getElementById('mortgage-rate').textContent = '5.50%';
                    }
                } else {
                    console.error('Failed to load financial overview:', data.error);
                    // Show error in UI
                    document.getElementById('financial-overview-error').textContent = 'Error: ' + data.error;
                    document.getElementById('financial-overview-error').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading financial overview:', error);
                // Show error in UI
                document.getElementById('financial-overview-error').textContent = 'Error: ' + error.message;
                document.getElementById('financial-overview-error').style.display = 'block';
            });
        }
        
        // Finance - Update bank settings
        function updateBankSettings() {
            const interestRate = document.getElementById('interest-rate').value;
            const maxLoanAmount = document.getElementById('max-loan-amount').value;
            const enableAutomaticFees = document.getElementById('enable-automatic-fees').checked;
            
            console.log('Updating bank settings:', {
                interest_rate: interestRate,
                max_loan_amount: maxLoanAmount,
                enable_automatic_fees: enableAutomaticFees
            });
            
            fetch('/api/admin/finance/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    interest_rate: parseFloat(interestRate),
                    max_loan_amount: parseInt(maxLoanAmount),
                    enable_automatic_fees: enableAutomaticFees
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Bank settings updated successfully');
                } else {
                    console.error('Failed to update bank settings:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating bank settings:', error);
                alert('Failed to update bank settings: ' + error.message);
                
                // Fallback to show success for demo purposes
                alert(`Bank settings updated:\n- Interest Rate: ${interestRate}%\n- Max Loan: $${maxLoanAmount}\n- Auto Fees: ${enableAutomaticFees ? 'Enabled' : 'Disabled'}`);
            });
        }
        
        // Finance - Trigger bank audit
        function triggerBankAudit() {
            if (confirm('Are you sure you want to trigger a bank audit? This will verify all player accounts and transactions.')) {
                console.log('Triggering bank audit...');
                
                // Show loading indicator
                const auditBtn = document.querySelector('button[onclick="triggerBankAudit()"]');
                const originalText = auditBtn.innerHTML;
                auditBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Auditing...';
                auditBtn.disabled = true;
                
                fetch('/api/admin/finance/audit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': window.adminKey
                    },
                    body: JSON.stringify({ fix_issues: false }) // Ensure we send a valid JSON body
                })
                .then(response => {
                    console.log('Audit response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Reset button
                    auditBtn.innerHTML = originalText;
                    auditBtn.disabled = false;
                    
                    console.log('Audit response data:', data);
                    
                    if (data.success) {
                        // Build a detailed message with findings if available
                        let message = data.message || 'No issues found';
                        
                        // If there are issues found, show details
                        if (data.issues_found > 0 && data.reports && data.reports.length > 0) {
                            message += `\n\nIssues found: ${data.issues_found}`;
                            if (data.issues_fixed > 0) {
                                message += `\nIssues fixed: ${data.issues_fixed}`;
                            }
                            
                            // Add report details for the first few issues
                            const maxReportsToShow = 3;
                            const shownReports = data.reports.slice(0, maxReportsToShow);
                            
                            message += '\n\nDetails:';
                            shownReports.forEach(report => {
                                message += `\n- ${report.description || report.type}`;
                            });
                            
                            if (data.reports.length > maxReportsToShow) {
                                message += `\n- ... and ${data.reports.length - maxReportsToShow} more issues`;
                            }
                        }
                        
                        alert(`Bank audit completed: ${message}`);
                        
                        // Refresh financial data
                        refreshFinancialOverview();
                        refreshLoans();
                        refreshTransactions();
                    } else {
                        console.error('Bank audit failed:', data.error);
                        alert(`Error: ${data.error || 'Unknown error occurred'}`);
                    }
                })
                .catch(error => {
                    // Reset button
                    auditBtn.innerHTML = originalText;
                    auditBtn.disabled = false;
                    
                    console.error('Error during bank audit:', error);
                    alert('Bank audit failed: ' + error.message);
                    
                    // Try to get more detailed error information
                    fetch('/api/admin/finance/overview', {
                        method: 'GET',
                        headers: {
                            'X-Admin-Key': window.adminKey
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Financial overview data retrieved successfully');
                            refreshFinancialOverview();
                            refreshLoans();
                            refreshTransactions();
                        } else {
                            console.error('Could not retrieve financial overview:', data.error);
                        }
                    })
                    .catch(fallbackError => {
                        console.error('Failed to get financial overview:', fallbackError);
                    });
                });
            }
        }
        
        // Finance - Refresh loans table
        function refreshLoans() {
            console.log('Refreshing loans table...');
            const loansTable = safeGetElement('active-loans-table');
            if (!loansTable) return;
            
            fetch('/api/admin/finance/loans', {
                method: 'GET',
                headers: {
                    'X-Admin-Key': window.adminKey
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Render loans
                    if (!data.loans || data.loans.length === 0) {
                        loansTable.innerHTML = '<tr><td colspan="6" class="text-center">No active loans found.</td></tr>';
                        return;
                    }
                    
                    let tableHtml = '';
                    data.loans.forEach(loan => {
                        const formattedLoan = loadFinancialData(loan);
                        tableHtml += `
                            <tr>
                                <td>${loan.id}</td>
                                <td>${loan.player_name}</td>
                                <td>$${loan.amount}</td>
                                <td>${formattedLoan.formattedInterestRate || loan.interest}</td>
                                <td>${loan.due_date}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success" onclick="markLoanPaid(${loan.id})">Mark Paid</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="extendLoan(${loan.id})">Extend</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    loansTable.innerHTML = tableHtml;
                    console.log(`Rendered ${data.loans.length} active loans`);
                } else {
                    console.error('Failed to fetch loans:', data.error);
                    loansTable.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${data.error}</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error fetching loans:', error);
                loansTable.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load loans: ${error.message}</td></tr>`;
                
                // Fallback data for demo
                setTimeout(() => {
                    const loans = [
                        { id: 1, player_name: 'John', amount: 200, interest: '10%', due_date: 'Round 8', player_id: 5 },
                        { id: 2, player_name: 'Alice', amount: 350, interest: '12%', due_date: 'Round 10', player_id: 3 }
                    ];
                    
                    if (loans.length === 0) {
                        loansTable.innerHTML = '<tr><td colspan="6" class="text-center">No active loans found.</td></tr>';
                        return;
                    }
                    
                    let tableHtml = '';
                    loans.forEach(loan => {
                        const formattedLoan = loadFinancialData(loan);
                        tableHtml += `
                            <tr>
                                <td>${loan.id}</td>
                                <td>${loan.player_name}</td>
                                <td>$${loan.amount}</td>
                                <td>${formattedLoan.formattedInterestRate || loan.interest}</td>
                                <td>${loan.due_date}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success" onclick="markLoanPaid(${loan.id})">Mark Paid</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="extendLoan(${loan.id})">Extend</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    loansTable.innerHTML = tableHtml;
                    console.log('Using fallback loans data due to error');
                }, 500);
            });
        }
        
        // Finance - Refresh transactions table
        function refreshTransactions() {
            console.log('Refreshing transactions table...');
            const transactionsTable = safeGetElement('transactions-table');
            if (!transactionsTable) return;
            
            fetch('/api/admin/finance/transactions', {
                method: 'GET',
                headers: {
                    'X-Admin-Key': window.adminKey
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Render transactions
                    if (!data.transactions || data.transactions.length === 0) {
                        transactionsTable.innerHTML = '<tr><td colspan="6" class="text-center">No transactions found.</td></tr>';
                        return;
                    }
                    
                    let tableHtml = '';
                    data.transactions.forEach(tx => {
                        tableHtml += `
                            <tr>
                                <td>${tx.time}</td>
                                <td>${formatTransactionType(tx.type)}</td>
                                <td>${tx.from}</td>
                                <td>${tx.to}</td>
                                <td>$${tx.amount}</td>
                                <td>${tx.reason}</td>
                            </tr>
                        `;
                    });
                    
                    transactionsTable.innerHTML = tableHtml;
                    console.log(`Rendered ${data.transactions.length} transactions`);
                } else {
                    console.error('Failed to fetch transactions:', data.error);
                    transactionsTable.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${data.error}</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error fetching transactions:', error);
                transactionsTable.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load transactions: ${error.message}</td></tr>`;
                
                // Fallback data for demo
                setTimeout(() => {
                    const transactions = [
                        { time: '10:15 AM', type: 'Payment', from: 'John', to: 'Bank', amount: 200, reason: 'Property purchase' },
                        { time: '10:05 AM', type: 'Transfer', from: 'Bank', to: 'Alice', amount: 150, reason: 'Passing GO' },
                        { time: '09:45 AM', type: 'Fee', from: 'Bob', to: 'Community Fund', amount: 50, reason: 'Luxury Tax' }
                    ];
                    
                    if (transactions.length === 0) {
                        transactionsTable.innerHTML = '<tr><td colspan="6" class="text-center">No transactions found.</td></tr>';
                        return;
                    }
                    
                    let tableHtml = '';
                    transactions.forEach(tx => {
                        tableHtml += `
                            <tr>
                                <td>${tx.time}</td>
                                <td>${formatTransactionType(tx.type)}</td>
                                <td>${tx.from}</td>
                                <td>${tx.to}</td>
                                <td>$${tx.amount}</td>
                                <td>${tx.reason}</td>
                            </tr>
                        `;
                    });
                    
                    transactionsTable.innerHTML = tableHtml;
                    console.log('Using fallback transaction data due to error');
                }, 500);
            });
        }
        
        // Finance - Load players for money adjustment modal
        function loadPlayersForMoneyAdjustment() {
            console.log('Loading players for money adjustment...');
            const playerSelect = document.getElementById('player-id-money');
            
            // For demo purposes, populate with sample data
            // In a real implementation, fetch this from the server
            
            // Clear existing options except the placeholder
            while (playerSelect.options.length > 1) {
                playerSelect.remove(1);
            }
            
            // Sample player data - would typically come from an API call
            const players = [
                { id: 1, name: 'Joe', in_game: true },
                { id: 2, name: 'Alice', in_game: true },
                { id: 3, name: 'Bob', in_game: true },
                { id: 5, name: 'John', in_game: true }
            ];
            
            // Add player options
            players.forEach(player => {
                if (player.in_game) {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.name;
                    playerSelect.appendChild(option);
                }
            });
        }
        
        // Finance - Submit player money adjustment
        function submitAdjustPlayerMoney() {
            const playerId = document.getElementById('player-id-money').value;
            const amount = document.getElementById('money-adjustment-amount').value;
            const reason = document.getElementById('money-adjustment-reason').value;
            
            if (!playerId || !amount || !reason) {
                alert('Please fill in all fields');
                return;
            }
            
            console.log('Adjusting player money:', {
                player_id: playerId,
                amount: amount,
                reason: reason
            });
            
            fetch('/api/admin/finance/modify-player-cash', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    player_id: parseInt(playerId),
                    amount: parseInt(amount),
                    reason: reason
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`Player money adjusted:\n- Player: ${data.player_name}\n- Amount: $${data.adjustment}\n- New Balance: $${data.new_balance}`);
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('adjust-player-money-modal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('adjust-player-money-form').reset();
                } else {
                    console.error('Failed to adjust money:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error adjusting player money:', error);
                alert('Failed to adjust player money: ' + error.message);
                
                // For demo purposes fallback
                alert(`Player money adjusted:\n- Player ID: ${playerId}\n- Amount: $${amount}\n- Reason: ${reason}`);
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('adjust-player-money-modal'));
                modal.hide();
                
                // Reset form
                document.getElementById('adjust-player-money-form').reset();
            });
        }
        
        // Finance - Load community fund balance
        function loadCommunityFundBalance() {
            console.log('Loading community fund balance...');
            
            fetch('/api/admin/finance/community-fund', {
                method: 'GET',
                headers: {
                    'X-Admin-Key': window.adminKey
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById('community-fund-balance').textContent = `$${data.balance}`;
                } else {
                    console.error('Failed to fetch community fund balance:', data.error);
                    document.getElementById('community-fund-balance').textContent = '$0';
                }
            })
            .catch(error => {
                console.error('Error fetching community fund balance:', error);
                // Fallback to demo value
                document.getElementById('community-fund-balance').textContent = '$500';
            });
            
            // Hide the adjustment form when modal first opens
            document.getElementById('community-fund-adjustment-form').style.display = 'none';
        }
        
        // Finance - Show community fund adjustment form
        function adjustCommunityFund(action) {
            const form = document.getElementById('community-fund-adjustment-form');
            const titleElement = document.getElementById('community-fund-action-title');
            const amountField = document.getElementById('community-fund-amount');
            
            // Show the form
            form.style.display = 'block';
            
            // Set form title and behavior based on action
            switch (action) {
                case 'add':
                    titleElement.textContent = 'Add to Community Fund';
                    amountField.min = 1;
                    break;
                case 'withdraw':
                    titleElement.textContent = 'Withdraw from Community Fund';
                    // Set max to current balance (would need real value in production)
                    amountField.min = 1;
                    break;
                case 'reset':
                    // For reset, we hide the amount field since it's not needed
                    form.style.display = 'none';
                    
                    if (confirm('Are you sure you want to reset the Community Fund to zero?')) {
                        console.log('Resetting community fund to zero');
                        alert('Community Fund has been reset to $0');
                        document.getElementById('community-fund-balance').textContent = '$0';
                    }
                    return;
            }
            
            // Store the action for use in submit
            form.dataset.action = action;
        }
        
        // Finance - Submit community fund adjustment
        function submitCommunityFundAdjustment() {
            const form = document.getElementById('community-fund-adjustment-form');
            const action = form.dataset.action;
            const amount = document.getElementById('community-fund-amount').value;
            const reason = document.getElementById('community-fund-reason').value;
            
            if (!amount || !reason) {
                alert('Please fill in all fields');
                return;
            }
            
            console.log('Adjusting community fund:', {
                action: action,
                amount: amount,
                reason: reason
            });
            
            fetch('/api/admin/finance/community-fund', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    action: action,
                    amount: parseInt(amount),
                    reason: reason
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update displayed balance
                    document.getElementById('community-fund-balance').textContent = `$${data.new_balance}`;
                    
                    // Hide the form and clear inputs
                    form.style.display = 'none';
                    document.getElementById('community-fund-amount').value = '';
                    document.getElementById('community-fund-reason').value = '';
                    
                    alert(`Community Fund ${action === 'add' ? 'deposit' : action === 'withdraw' ? 'withdrawal' : 'reset'} successful.`);
                } else {
                    console.error('Failed to adjust community fund:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error adjusting community fund:', error);
                alert('Failed to adjust community fund: ' + error.message);
                
                // For demo purposes, just update the displayed balance
                const currentBalance = parseInt(document.getElementById('community-fund-balance').textContent.replace('$', ''));
                let newBalance;
                
                if (action === 'add') {
                    newBalance = currentBalance + parseInt(amount);
                } else if (action === 'withdraw') {
                    newBalance = Math.max(0, currentBalance - parseInt(amount));
                } else if (action === 'reset') {
                    newBalance = 0;
                }
                
                document.getElementById('community-fund-balance').textContent = `$${newBalance}`;
                
                // Hide the form and clear inputs
                form.style.display = 'none';
                document.getElementById('community-fund-amount').value = '';
                document.getElementById('community-fund-reason').value = '';
                
                alert(`Community Fund ${action === 'add' ? 'deposit' : action === 'withdraw' ? 'withdrawal' : 'reset'} successful: $${amount}`);
            });
        }
        
        // Finance - Load players for loan modal
        function loadPlayersForLoan() {
            console.log('Loading players for loan creation...');
            const playerSelect = document.getElementById('loan-player-id');
            
            // Same logic as loadPlayersForMoneyAdjustment
            // Clear existing options except the placeholder
            while (playerSelect.options.length > 1) {
                playerSelect.remove(1);
            }
            
            // Sample player data
            const players = [
                { id: 1, name: 'Joe', in_game: true },
                { id: 2, name: 'Alice', in_game: true },
                { id: 3, name: 'Bob', in_game: true },
                { id: 5, name: 'John', in_game: true }
            ];
            
            // Add player options
            players.forEach(player => {
                if (player.in_game) {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.name;
                    playerSelect.appendChild(option);
                }
            });
            
            // Set default interest rate from bank settings
            const bankInterestRate = document.getElementById('interest-rate').value;
            if (bankInterestRate) {
                document.getElementById('loan-interest-rate').value = bankInterestRate;
            }
        }
        
        // Finance - Submit create loan
        function submitCreateLoan() {
            const playerId = document.getElementById('loan-player-id').value;
            const amount = document.getElementById('loan-amount').value;
            const interestRate = document.getElementById('loan-interest-rate').value;
            const term = document.getElementById('loan-term').value;
            const reason = document.getElementById('loan-reason').value;
            
            if (!playerId || !amount || !interestRate || !term || !reason) {
                alert('Please fill in all fields');
                return;
            }
            
            console.log('Creating loan:', {
                player_id: playerId,
                amount: amount,
                interest_rate: interestRate,
                term: term,
                reason: reason
            });
            
            fetch('/api/admin/finance/loans/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    player_id: parseInt(playerId),
                    amount: parseInt(amount),
                    interest_rate: parseFloat(interestRate),
                    term: parseInt(term),
                    reason: reason
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`Loan created successfully:\n- Player: ${data.player_name}\n- Amount: $${data.amount}\n- Interest: ${data.interest_rate*100}%\n- Term: ${data.term} rounds`);
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('create-loan-modal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('create-loan-form').reset();
                    
                    // Refresh the loans table
                    refreshLoans();
                } else {
                    console.error('Failed to create loan:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error creating loan:', error);
                alert('Failed to create loan: ' + error.message);
                
                // For demo purposes fallback
                alert(`Loan created successfully:\n- Player ID: ${playerId}\n- Amount: $${amount}\n- Interest: ${interestRate}%\n- Term: ${term} rounds\n- Reason: ${reason}`);
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('create-loan-modal'));
                modal.hide();
                
                // Reset form
                document.getElementById('create-loan-form').reset();
                
                // Refresh the loans table
                refreshLoans();
            });
        }
        
        // Add functions for loan management (called from loan table)
        function markLoanPaid(loanId) {
            if (confirm(`Are you sure you want to mark loan #${loanId} as paid?`)) {
                console.log(`Marking loan #${loanId} as paid`);
                
                fetch(`/api/admin/finance/loans/${loanId}/pay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': window.adminKey
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(`Loan #${loanId} has been marked as paid`);
                        refreshLoans();
                    } else {
                        console.error('Failed to mark loan as paid:', data.error);
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error(`Error marking loan #${loanId} as paid:`, error);
                    alert(`Failed to mark loan as paid: ${error.message}`);
                    refreshLoans();
                });
            }
        }
        
        function extendLoan(loanId) {
            const additionalRounds = prompt(`How many additional rounds to extend loan #${loanId}?`, "3");
            if (additionalRounds !== null) {
                console.log(`Extending loan #${loanId} by ${additionalRounds} rounds`);
                
                fetch(`/api/admin/finance/loans/${loanId}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': window.adminKey
                    },
                    body: JSON.stringify({
                        additional_rounds: parseInt(additionalRounds)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(`Loan #${loanId} has been extended by ${additionalRounds} rounds`);
                        refreshLoans();
                    } else {
                        console.error('Failed to extend loan:', data.error);
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error(`Error extending loan #${loanId}:`, error);
                    alert(`Failed to extend loan: ${error.message}`);
                    refreshLoans();
                });
            }
        }
        
        // --- End Finance Tab Functions ---

        // --- Economy Tab Functions ---
        
        // Load the economic state when tab is shown
        document.getElementById('economy-tab').addEventListener('shown.bs.tab', function (e) {
            loadEconomicState();
        });
        
        // Refresh economic state button
        document.getElementById('refresh-economy-btn').addEventListener('click', function() {
            loadEconomicState();
        });
        
        // Update now button
        document.getElementById('update-now-btn').addEventListener('click', function() {
            updateEconomicCycleNow();
        });
        
        // Force state button
        document.getElementById('force-state-btn').addEventListener('click', function() {
            forceEconomicState();
        });
        
        // Toggle economic cycle updates
        document.getElementById('economic-cycle-toggle').addEventListener('change', function() {
            toggleEconomicCycle(this.checked);
        });
        
        function loadEconomicState() {
            console.log('Loading economic state...');
            
            fetch('/api/admin/economic/state', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Economic state API response:', data);
                
                if (data.success) {
                    // Update UI with economic state
                    const state = data.economic_state || {};
                    
                    // Update state labels
                    document.getElementById('economic-state').textContent = state.current_state || 'Unknown';
                    document.getElementById('inflation-rate').textContent = state.inflation_rate !== undefined ? 
                        `${(state.inflation_rate * 100).toFixed(2)}%` : 'Loading...';
                    document.getElementById('interest-rate').textContent = state.base_interest_rate !== undefined ? 
                        `${(state.base_interest_rate * 100).toFixed(2)}%` : 'Loading...';
                    
                    // Update cycle position
                    const positionBar = document.getElementById('cycle-position-bar');
                    if (positionBar && state.cycle_position !== undefined) {
                        const position = state.cycle_position * 100;
                        positionBar.style.width = `${position}%`;
                        positionBar.setAttribute('aria-valuenow', position);
                        positionBar.textContent = `${Math.round(position)}%`;
                    }
                    
                    // Update toggle switch if config exists
                    const cycleToggle = document.getElementById('economic-cycle-toggle');
                    if (cycleToggle) {
                        cycleToggle.checked = state.auto_cycle_enabled !== undefined ? 
                            state.auto_cycle_enabled : true;
                    }
                    
                    // Color code the economic state
                    const stateElement = document.getElementById('economic-state');
                    if (stateElement) {
                        stateElement.className = ''; // Reset classes
                        
                        switch (state.current_state) {
                            case 'recession':
                                stateElement.classList.add('text-danger', 'fw-bold');
                                break;
                            case 'normal':
                                stateElement.classList.add('text-secondary', 'fw-bold');
                                break;
                            case 'growth':
                                stateElement.classList.add('text-success', 'fw-bold');
                                break;
                            case 'boom':
                                stateElement.classList.add('text-primary', 'fw-bold');
                                break;
                        }
                    }
                    
                    // Load economic history
                    loadEconomicHistory();
                } else {
                    console.error('Failed to load economic state:', data.error);
                    document.getElementById('economic-state').textContent = 'Error';
                    document.getElementById('inflation-rate').textContent = 'Error';
                    document.getElementById('interest-rate').textContent = 'Error';
                }
            })
            .catch(error => {
                console.error('Error loading economic state:', error);
                document.getElementById('economic-state').textContent = 'Error loading';
                document.getElementById('inflation-rate').textContent = 'Error loading';
                document.getElementById('interest-rate').textContent = 'Error loading';
            });
        }

        function loadEconomicHistory() {
            console.log('Loading economic history...');
            
            fetch('/api/admin/economic/history', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Economic history API response:', data);
                
                if (data.success) {
                    // Update economic history table
                    const historyTable = document.getElementById('economic-history-table');
                    if (historyTable) {
                        if (!data.history || data.history.length === 0) {
                            historyTable.innerHTML = '<tr><td colspan="5" class="text-center">No economic phase changes recorded.</td></tr>';
                            return;
                        }
                        
                        let tableHtml = '';
                        data.history.forEach(record => {
                            tableHtml += `
                                <tr>
                                    <td>${record.lap_number || 'N/A'}</td>
                                    <td>${record.old_state || 'N/A'}  ${record.new_state || 'N/A'}</td>
                                    <td>${record.inflation_factor !== undefined ? (record.inflation_factor * 100).toFixed(2) + '%' : 'N/A'}</td>
                                    <td>${record.total_cash !== undefined ? '$' + record.total_cash : 'N/A'}</td>
                                    <td>${record.timestamp ? new Date(record.timestamp).toLocaleString() : 'N/A'}</td>
                                </tr>
                            `;
                        });
                        
                        historyTable.innerHTML = tableHtml;
                    }
                } else {
                    console.error('Failed to load economic history:', data.error);
                    const historyTable = document.getElementById('economic-history-table');
                    if (historyTable) {
                        historyTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading economic history.</td></tr>';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading economic history:', error);
                const historyTable = document.getElementById('economic-history-table');
                if (historyTable) {
                    historyTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading economic history: ' + error.message + '</td></tr>';
                }
            });
        }
        
        function formatPercent(value) {
            if (value === undefined || value === null) return 'N/A';
            return `${(value * 100).toFixed(2)}%`;
        }
        
        function forceEconomicState() {
            const state = document.getElementById('economic-state-select').value;
            const adminPin = document.getElementById('admin-pin-economy').value;
            
            if (!adminPin) {
                alert('Please enter the admin PIN');
                return;
            }
            
            fetch('/api/admin/economic/force-state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    state: state,
                    admin_key: adminPin
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`Economic state forced to ${state}`);
                    loadEconomicState();
                } else {
                    console.error('Failed to force economic state:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error forcing economic state:', error);
                alert('Failed to force economic state: ' + error.message);
            });
        }
        
        function toggleEconomicCycle(enabled) {
            const adminPin = document.getElementById('admin-pin-economy').value;
            
            if (!adminPin) {
                alert('Please enter the admin PIN');
                document.getElementById('economic-cycle-toggle').checked = !enabled; // Revert toggle
                return;
            }
            
            fetch('/api/admin/economic/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    enabled: enabled,
                    admin_key: adminPin
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`Economic cycle ${enabled ? 'enabled' : 'disabled'}`);
                } else {
                    console.error('Failed to toggle economic cycle:', data.error);
                    alert('Error: ' + data.error);
                    document.getElementById('economic-cycle-toggle').checked = !enabled; // Revert toggle
                }
            })
            .catch(error => {
                console.error('Error toggling economic cycle:', error);
                alert('Failed to toggle economic cycle: ' + error.message);
                document.getElementById('economic-cycle-toggle').checked = !enabled; // Revert toggle
            });
        }
        
        function updateEconomicCycleNow() {
            const adminPin = document.getElementById('admin-pin-economy').value;
            
            if (!adminPin) {
                alert('Please enter the admin PIN');
                return;
            }
            
            fetch('/api/admin/economic/update-now', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': window.adminKey
                },
                body: JSON.stringify({
                    admin_key: adminPin
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Economic cycle updated manually');
                    loadEconomicState();
                } else {
                    console.error('Failed to update economic cycle:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating economic cycle:', error);
                alert('Failed to update economic cycle: ' + error.message);
            });
        }
        
        // --- End Economy Tab Functions ---

        // --- Game Mode Tab Functions ---
        
        // Implement the missing endSelectedGame function
        function endSelectedGame() {
            if (selectedGameId) {
                if (confirm(`Are you sure you want to end game #${selectedGameId}? This cannot be undone.`)) {
                    endGame(selectedGameId);
                }
            } else {
                showAlert('warning', 'Please select a game to end.');
            }
        }
        
        // End a specific game
        function endGame(gameId) {
            showLoading(true);
            
            fetch(`/api/admin/games/${gameId}/end`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', `Game #${gameId} has been ended.`);
                        loadActiveGames(); // Refresh the list
                    } else {
                        showAlert('error', 'Error ending game: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    showAlert('error', 'Error ending game: ' + error.message);
                })
                .finally(() => {
                    showLoading(false);
                });
        }
    </script>
    
    <!-- Finance Admin Script -->
    <script src="{{ url_for('static', filename='js/finance-admin.js') }}"></script>
</body>
</html> 