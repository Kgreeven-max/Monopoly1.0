<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi-nopoly Admin - Player Management</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .player-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .player-stat {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .player-label {
            color: #666;
            font-size: 14px;
        }
        
        .player-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .player-table th, .player-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .player-table th {
            background-color: #f2f2f2;
        }
        
        .player-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .player-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tabs {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }
        
        .tabs button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }
        
        .tabs button:hover {
            background-color: #ddd;
        }
        
        .tabs button.active {
            background-color: #ccc;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .property-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .property-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-users"></i> Pi-nopoly Admin - Player Management</h1>
            <nav>
                <a href="/admin" class="button"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="/admin_player" class="button active"><i class="fas fa-users"></i> Players</a>
                <a href="/admin_crime" class="button"><i class="fas fa-shield-alt"></i> Crime</a>
                <a href="/admin_game_modes" class="button"><i class="fas fa-gamepad"></i> Game Modes</a>
                <a href="/admin_remote_play" class="button"><i class="fas fa-wifi"></i> Remote Play</a>
            </nav>
        </header>

        <main>
            <div class="tabs">
                <button class="tablink active" onclick="openTab(event, 'overview')">Player Overview</button>
                <button class="tablink" onclick="openTab(event, 'management')">Player Management</button>
                <button class="tablink" onclick="openTab(event, 'finances')">Player Finances</button>
                <button class="tablink" onclick="openTab(event, 'properties')">Player Properties</button>
                <button class="tablink" onclick="openTab(event, 'audit')">Player Audit</button>
            </div>
            
            <!-- Player Overview Tab -->
            <div id="overview" class="tab-content active">
                <h2>Player Overview</h2>
                <div class="player-grid">
                    <div class="player-card">
                        <div class="player-label">Total Players</div>
                        <div class="player-stat" id="total-players">-</div>
                    </div>
                    <div class="player-card">
                        <div class="player-label">Human Players</div>
                        <div class="player-stat" id="human-players">-</div>
                    </div>
                    <div class="player-card">
                        <div class="player-label">Bot Players</div>
                        <div class="player-stat" id="bot-players">-</div>
                    </div>
                    <div class="player-card">
                        <div class="player-label">Players in Jail</div>
                        <div class="player-stat" id="jailed-players">-</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="player-search" placeholder="Search players...">
                    <button onclick="searchPlayers()">Search</button>
                </div>
                
                <table class="player-table" id="players-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Cash</th>
                            <th>Net Worth</th>
                            <th>Position</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="players-list">
                        <!-- Player rows will be populated dynamically -->
                    </tbody>
                </table>
                
                <div class="player-actions">
                    <button class="button" onclick="openAddPlayerModal()">Add Player</button>
                    <button class="button" onclick="openAddBotModal()">Add Bot</button>
                    <button class="button danger" onclick="confirmResetAllPlayers()">Reset All Players</button>
                </div>
            </div>
            
            <!-- Player Management Tab -->
            <div id="management" class="tab-content">
                <h2>Player Management</h2>
                
                <div class="management-section">
                    <h3>Selected Player: <span id="selected-player-name">None</span></h3>
                    
                    <div class="player-details" id="player-details-container">
                        <p>Select a player from the dropdown to view and manage details.</p>
                    </div>
                    
                    <div class="player-selector">
                        <select id="player-selector" onchange="loadPlayerDetails()">
                            <option value="">-- Select Player --</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <button class="button" onclick="refreshPlayerList()">Refresh List</button>
                    </div>
                    
                    <div class="management-actions" id="management-actions">
                        <button class="button" onclick="modifyCash()">Modify Cash</button>
                        <button class="button" onclick="teleportPlayer()">Teleport Player</button>
                        <button class="button" onclick="toggleJailStatus()">Toggle Jail Status</button>
                        <button class="button danger" onclick="confirmRemovePlayer()">Remove Player</button>
                    </div>
                </div>
                
                <div class="player-status-section">
                    <h3>Player Status Updates</h3>
                    <div class="status-updates" id="status-updates">
                        <!-- Status updates will appear here -->
                        <p class="no-updates">No recent status updates.</p>
                    </div>
                </div>
            </div>
            
            <!-- Player Finances Tab -->
            <div id="finances" class="tab-content">
                <h2>Player Finances</h2>
                
                <div class="finance-section">
                    <h3>Financial Overview</h3>
                    
                    <div class="player-selector">
                        <select id="finance-player-selector" onchange="loadPlayerFinances()">
                            <option value="">-- Select Player --</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <button class="button" onclick="refreshFinancePlayerList()">Refresh List</button>
                    </div>
                    
                    <div class="player-finances" id="player-finances">
                        <p>Select a player to view their finances.</p>
                    </div>
                </div>
                
                <div class="finance-actions">
                    <button class="button" onclick="openModifyCashModal()">Modify Cash</button>
                    <button class="button" onclick="openAddLoanModal()">Add Loan</button>
                    <button class="button" onclick="openForgiveDebtModal()">Forgive Debt</button>
                    <button class="button" onclick="runFinancialAudit()">Run Financial Audit</button>
                </div>
                
                <div class="finance-history">
                    <h3>Transaction History</h3>
                    <table class="player-table" id="transaction-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Amount</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list">
                            <!-- Transactions will be populated dynamically -->
                            <tr>
                                <td colspan="7" class="center">Select a player to view transactions.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Player Properties Tab -->
            <div id="properties" class="tab-content">
                <h2>Player Properties</h2>
                
                <div class="property-section">
                    <div class="player-selector">
                        <select id="property-player-selector" onchange="loadPlayerProperties()">
                            <option value="">-- Select Player --</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <button class="button" onclick="refreshPropertyPlayerList()">Refresh List</button>
                    </div>
                    
                    <div class="player-properties" id="player-properties">
                        <p>Select a player to view their properties.</p>
                    </div>
                </div>
                
                <div class="property-actions">
                    <button class="button" onclick="openTransferPropertyModal()">Transfer Property</button>
                    <button class="button" onclick="openMortgagePropertyModal()">Mortgage/Unmortgage</button>
                    <button class="button" onclick="openAddHousesModal()">Add/Remove Houses</button>
                </div>
                
                <div class="property-management">
                    <h3>Property Details</h3>
                    <div id="property-details">
                        <p>Select a property from a player's portfolio to view details.</p>
                    </div>
                </div>
                
                <div class="property-transfer-history">
                    <h3>Property Transfer History</h3>
                    <table class="player-table" id="property-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Property</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Price</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="property-history-list">
                            <!-- Property history will be populated dynamically -->
                            <tr>
                                <td colspan="6" class="center">Select a player to view property history.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Player Audit Tab -->
            <div id="audit" class="tab-content">
                <h2>Player Audit</h2>
                
                <div class="audit-section">
                    <div class="player-selector">
                        <select id="audit-player-selector" onchange="loadPlayerForAudit()">
                            <option value="">-- Select Player --</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <button class="button" onclick="refreshAuditPlayerList()">Refresh List</button>
                    </div>
                    
                    <div class="audit-actions">
                        <button class="button" onclick="performFullAudit()">Perform Full Audit</button>
                        <button class="button" onclick="performFinancialAudit()">Financial Audit</button>
                        <button class="button" onclick="performPropertyAudit()">Property Audit</button>
                        <button class="button" onclick="performActivityAudit()">Activity Audit</button>
                    </div>
                    
                    <div class="audit-results" id="audit-results">
                        <p>Select a player and perform an audit to see results.</p>
                    </div>
                </div>
                
                <div class="audit-history">
                    <h3>Previous Audits</h3>
                    <table class="player-table" id="audit-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Player</th>
                                <th>Type</th>
                                <th>Result</th>
                                <th>Issues Found</th>
                                <th>Actions Taken</th>
                            </tr>
                        </thead>
                        <tbody id="audit-history-list">
                            <!-- Audit history will be populated dynamically -->
                            <tr>
                                <td colspan="6" class="center">No previous audits found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Player Modal -->
    <div id="add-player-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2>Add New Player</h2>
            <form id="add-player-form">
                <div class="form-group">
                    <label for="new-player-name">Player Name:</label>
                    <input type="text" id="new-player-name" required>
                </div>
                <div class="form-group">
                    <label for="new-player-token">Token Color:</label>
                    <select id="new-player-token">
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-player-starting-cash">Starting Cash:</label>
                    <input type="number" id="new-player-starting-cash" value="1500">
                </div>
                <button type="submit" class="button">Add Player</button>
            </form>
        </div>
    </div>

    <!-- Add Bot Modal -->
    <div id="add-bot-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2>Add Bot Player</h2>
            <form id="add-bot-form">
                <div class="form-group">
                    <label for="new-bot-name">Bot Name (optional):</label>
                    <input type="text" id="new-bot-name" placeholder="Random name will be generated if empty">
                </div>
                <div class="form-group">
                    <label for="new-bot-type">Bot Type:</label>
                    <select id="new-bot-type">
                        <option value="conservative">Conservative</option>
                        <option value="aggressive">Aggressive</option>
                        <option value="strategic">Strategic</option>
                        <option value="opportunistic">Opportunistic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-bot-difficulty">Difficulty:</label>
                    <select id="new-bot-difficulty">
                        <option value="easy">Easy</option>
                        <option value="normal">Normal</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-bot-starting-cash">Starting Cash:</label>
                    <input type="number" id="new-bot-starting-cash" value="1500">
                </div>
                <button type="submit" class="button">Add Bot</button>
            </form>
        </div>
    </div>

    <!-- Modify Cash Modal -->
    <div id="modify-cash-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2>Modify Player Cash</h2>
            <form id="modify-cash-form">
                <div class="form-group">
                    <label for="modify-cash-player-id">Player:</label>
                    <select id="modify-cash-player-id" required>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="modify-cash-amount">Amount:</label>
                    <input type="number" id="modify-cash-amount" required>
                    <small>Use positive value to add cash, negative to remove cash</small>
                </div>
                <div class="form-group">
                    <label for="modify-cash-reason">Reason:</label>
                    <input type="text" id="modify-cash-reason" placeholder="Admin adjustment">
                </div>
                <button type="submit" class="button">Modify Cash</button>
            </form>
        </div>
    </div>

    <!-- Transfer Property Modal -->
    <div id="transfer-property-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2>Transfer Property</h2>
            <form id="transfer-property-form">
                <div class="form-group">
                    <label for="transfer-property-id">Property:</label>
                    <select id="transfer-property-id" required>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transfer-from-player-id">From:</label>
                    <select id="transfer-from-player-id">
                        <option value="">Bank</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transfer-to-player-id">To:</label>
                    <select id="transfer-to-player-id">
                        <option value="">Bank</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transfer-property-reason">Reason:</label>
                    <input type="text" id="transfer-property-reason" placeholder="Admin transfer">
                </div>
                <button type="submit" class="button">Transfer Property</button>
            </form>
        </div>
    </div>

    <!-- Remove Player Confirmation Modal -->
    <div id="remove-player-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2>Remove Player</h2>
            <p>Are you sure you want to remove this player from the game?</p>
            <form id="remove-player-form">
                <div class="form-group">
                    <label for="remove-player-id">Player:</label>
                    <select id="remove-player-id" required>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="remove-player-handle-properties">Handle Properties:</label>
                    <select id="remove-player-handle-properties">
                        <option value="bank">Return to Bank</option>
                        <option value="auction">Auction</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="remove-player-reason">Reason:</label>
                    <input type="text" id="remove-player-reason" placeholder="Admin removal">
                </div>
                <div class="form-group">
                    <button type="submit" class="button danger">Remove Player</button>
                    <button type="button" class="button" onclick="closeModals()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Tab handling
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            
            const tablinks = document.getElementsByClassName("tablink");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            // Load data based on tab
            if (tabName === 'overview') {
                loadPlayersOverview();
            } else if (tabName === 'management') {
                populatePlayerSelector();
            } else if (tabName === 'finances') {
                populateFinancePlayerSelector();
            } else if (tabName === 'properties') {
                populatePropertyPlayerSelector();
            } else if (tabName === 'audit') {
                populateAuditPlayerSelector();
            }
        }
        
        // Modal handling
        function openAddPlayerModal() {
            document.getElementById('add-player-modal').style.display = 'block';
        }
        
        function openAddBotModal() {
            document.getElementById('add-bot-modal').style.display = 'block';
        }
        
        function openModifyCashModal() {
            // Populate the player dropdown
            const selectElement = document.getElementById('modify-cash-player-id');
            selectElement.innerHTML = '';
            
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.username} ($${player.money})`;
                    selectElement.appendChild(option);
                });
                
                document.getElementById('modify-cash-modal').style.display = 'block';
            });
        }
        
        function openTransferPropertyModal() {
            // Populate property and player dropdowns
            const propertySelect = document.getElementById('transfer-property-id');
            const fromPlayerSelect = document.getElementById('transfer-from-player-id');
            const toPlayerSelect = document.getElementById('transfer-to-player-id');
            
            propertySelect.innerHTML = '';
            fromPlayerSelect.innerHTML = '<option value="">Bank</option>';
            toPlayerSelect.innerHTML = '<option value="">Bank</option>';
            
            // Fetch all properties
            fetch('/api/admin/properties')
                .then(response => response.json())
                .then(data => {
                    data.properties.forEach(property => {
                        const option = document.createElement('option');
                        option.value = property.id;
                        option.textContent = `${property.name} (${property.group})`;
                        propertySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching properties:', error));
            
            // Fetch all players for from/to dropdowns
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const fromOption = document.createElement('option');
                    fromOption.value = player.id;
                    fromOption.textContent = player.username;
                    fromPlayerSelect.appendChild(fromOption);
                    
                    const toOption = document.createElement('option');
                    toOption.value = player.id;
                    toOption.textContent = player.username;
                    toPlayerSelect.appendChild(toOption);
                });
                
                document.getElementById('transfer-property-modal').style.display = 'block';
            });
        }
        
        function confirmRemovePlayer() {
            // Populate player dropdown
            const selectElement = document.getElementById('remove-player-id');
            selectElement.innerHTML = '';
            
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.username;
                    selectElement.appendChild(option);
                });
                
                document.getElementById('remove-player-modal').style.display = 'block';
            });
        }
        
        function closeModals() {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                modals[i].style.display = 'none';
            }
        }
        
        // Data fetching functions
        function fetchPlayers() {
            return fetch('/api/admin/game/status')
                .then(response => response.json())
                .then(data => data.players || [])
                .catch(error => {
                    console.error('Error fetching players:', error);
                    return [];
                });
        }
        
        function loadPlayersOverview() {
            fetchPlayers().then(players => {
                // Update stats
                document.getElementById('total-players').textContent = players.length;
                document.getElementById('human-players').textContent = players.filter(p => !p.is_bot).length;
                document.getElementById('bot-players').textContent = players.filter(p => p.is_bot).length;
                document.getElementById('jailed-players').textContent = players.filter(p => p.in_jail).length;
                
                // Update table
                const tableBody = document.getElementById('players-list');
                tableBody.innerHTML = '';
                
                players.forEach(player => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${player.id}</td>
                        <td>${player.username}</td>
                        <td>${player.is_bot ? 'Bot' : 'Human'}</td>
                        <td>$${player.money}</td>
                        <td>$${player.net_worth || 'N/A'}</td>
                        <td>${player.position}</td>
                        <td>${getPlayerStatus(player)}</td>
                        <td>
                            <button onclick="viewPlayer(${player.id})">View</button>
                            <button onclick="modifyPlayerCash(${player.id})">Cash</button>
                            <button onclick="removePlayer(${player.id})">Remove</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            });
        }
        
        function getPlayerStatus(player) {
            if (!player.in_game) return 'Not in game';
            if (player.is_bankrupt) return 'Bankrupt';
            if (player.in_jail) return 'In Jail';
            if (player.turn_status === 'active') return 'Active Turn';
            return 'In Game';
        }
        
        function populatePlayerSelector() {
            const selectElement = document.getElementById('player-selector');
            selectElement.innerHTML = '<option value="">-- Select Player --</option>';
            
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.username;
                    selectElement.appendChild(option);
                });
            });
        }
        
        function populateFinancePlayerSelector() {
            const selectElement = document.getElementById('finance-player-selector');
            selectElement.innerHTML = '<option value="">-- Select Player --</option>';
            
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.username;
                    selectElement.appendChild(option);
                });
            });
        }
        
        function populatePropertyPlayerSelector() {
            const selectElement = document.getElementById('property-player-selector');
            selectElement.innerHTML = '<option value="">-- Select Player --</option>';
            
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.username;
                    selectElement.appendChild(option);
                });
            });
        }
        
        function populateAuditPlayerSelector() {
            const selectElement = document.getElementById('audit-player-selector');
            selectElement.innerHTML = '<option value="">-- Select Player --</option>';
            
            fetchPlayers().then(players => {
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.username;
                    selectElement.appendChild(option);
                });
            });
        }
        
        function loadPlayerDetails() {
            const playerId = document.getElementById('player-selector').value;
            if (!playerId) {
                document.getElementById('player-details-container').innerHTML = 
                    '<p>Select a player from the dropdown to view and manage details.</p>';
                document.getElementById('selected-player-name').textContent = 'None';
                return;
            }
            
            fetch(`/api/players/${playerId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('selected-player-name').textContent = data.username;
                    
                    const detailsHtml = `
                        <div class="player-detail-card">
                            <h4>Basic Info</h4>
                            <p><strong>ID:</strong> ${data.id}</p>
                            <p><strong>Name:</strong> ${data.username}</p>
                            <p><strong>Type:</strong> ${data.is_bot ? 'Bot' : 'Human'}</p>
                            <p><strong>Status:</strong> ${getPlayerStatus(data)}</p>
                            
                            <h4>Financial Info</h4>
                            <p><strong>Cash:</strong> $${data.money}</p>
                            <p><strong>Net Worth:</strong> $${data.net_worth || 'N/A'}</p>
                            <p><strong>Loans:</strong> ${data.loans?.length || 0}</p>
                            <p><strong>Credit Score:</strong> ${data.credit_score || 'N/A'}</p>
                            
                            <h4>Game Info</h4>
                            <p><strong>Position:</strong> ${data.position}</p>
                            <p><strong>In Jail:</strong> ${data.in_jail ? 'Yes' : 'No'}</p>
                            <p><strong>Jail Turns:</strong> ${data.jail_turns || 0}</p>
                            <p><strong>Get Out of Jail Cards:</strong> ${data.jail_cards?.length || 0}</p>
                            
                            <h4>Properties</h4>
                            <div class="property-list">
                                ${data.properties && data.properties.length > 0 ? 
                                    data.properties.map(p => 
                                        `<span class="property-badge" style="background-color: ${getPropertyColor(p.group)}">
                                            ${p.name}${p.is_mortgaged ? ' (M)' : ''}
                                        </span>`
                                    ).join('') : 
                                    'No properties owned'}
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('player-details-container').innerHTML = detailsHtml;
                    document.getElementById('management-actions').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching player details:', error);
                    document.getElementById('player-details-container').innerHTML = 
                        '<p class="error">Error loading player details. Please try again.</p>';
                });
        }
        
        function getPropertyColor(group) {
            const colors = {
                'Brown': '#8B4513',
                'Light Blue': '#87CEEB',
                'Pink': '#FFC0CB',
                'Orange': '#FFA500',
                'Red': '#FF0000',
                'Yellow': '#FFFF00',
                'Green': '#008000',
                'Dark Blue': '#00008B',
                'Railroad': '#000000',
                'Utility': '#A9A9A9'
            };
            
            return colors[group] || '#CCCCCC';
        }
        
        function loadPlayerFinances() {
            const playerId = document.getElementById('finance-player-selector').value;
            if (!playerId) {
                document.getElementById('player-finances').innerHTML = 
                    '<p>Select a player to view their finances.</p>';
                document.getElementById('transaction-list').innerHTML = 
                    '<tr><td colspan="7" class="center">Select a player to view transactions.</td></tr>';
                return;
            }
            
            // Fetch player financial details
            fetch(`/api/finance/player/${playerId}/financial-summary`)
                .then(response => response.json())
                .then(data => {
                    const financesHtml = `
                        <div class="finances-detail-card">
                            <h4>Current Balances</h4>
                            <p><strong>Cash:</strong> $${data.cash}</p>
                            <p><strong>Net Worth:</strong> $${data.net_worth}</p>
                            <p><strong>Property Value:</strong> $${data.property_value}</p>
                            <p><strong>Credit Score:</strong> ${data.credit_score} (${getCreditRating(data.credit_score)})</p>
                            
                            <h4>Loans</h4>
                            <div class="loan-list">
                                ${data.loans && data.loans.length > 0 ? 
                                    data.loans.map(loan => 
                                        `<div class="loan-item">
                                            <p><strong>Loan #${loan.id}:</strong> $${loan.amount} at ${loan.interest_rate}%</p>
                                            <p><small>Due: ${new Date(loan.due_date).toLocaleDateString()}</small></p>
                                        </div>`
                                    ).join('') : 
                                    '<p>No active loans</p>'}
                            </div>
                            
                            <h4>CDs & Investments</h4>
                            <div class="cd-list">
                                ${data.cds && data.cds.length > 0 ? 
                                    data.cds.map(cd => 
                                        `<div class="cd-item">
                                            <p><strong>CD #${cd.id}:</strong> $${cd.amount} at ${cd.interest_rate}%</p>
                                            <p><small>Matures: ${new Date(cd.maturity_date).toLocaleDateString()}</small></p>
                                        </div>`
                                    ).join('') : 
                                    '<p>No active CDs</p>'}
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('player-finances').innerHTML = financesHtml;
                })
                .catch(error => {
                    console.error('Error fetching player finances:', error);
                    document.getElementById('player-finances').innerHTML = 
                        '<p class="error">Error loading financial details. Please try again.</p>';
                });
            
            // Fetch transaction history
            fetch(`/api/finance/transactions?player_id=${playerId}&limit=20`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('transaction-list');
                    tableBody.innerHTML = '';
                    
                    if (!data.transactions || data.transactions.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="center">No transactions found for this player.</td></tr>';
                        return;
                    }
                    
                    data.transactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transaction.id}</td>
                            <td>${new Date(transaction.timestamp).toLocaleString()}</td>
                            <td>${transaction.transaction_type}</td>
                            <td>${transaction.from_player_name || 'Bank'}</td>
                            <td>${transaction.to_player_name || 'Bank'}</td>
                            <td>$${transaction.amount}</td>
                            <td>${transaction.description}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                    document.getElementById('transaction-list').innerHTML = 
                        '<tr><td colspan="7" class="center">Error loading transactions. Please try again.</td></tr>';
                });
        }
        
        function getCreditRating(score) {
            if (score >= 800) return 'Excellent';
            if (score >= 700) return 'Good';
            if (score >= 600) return 'Fair';
            if (score >= 500) return 'Poor';
            return 'Very Poor';
        }
        
        function loadPlayerProperties() {
            const playerId = document.getElementById('property-player-selector').value;
            if (!playerId) {
                document.getElementById('player-properties').innerHTML = 
                    '<p>Select a player to view their properties.</p>';
                document.getElementById('property-history-list').innerHTML = 
                    '<tr><td colspan="6" class="center">Select a player to view property history.</td></tr>';
                return;
            }
            
            // Fetch player property details
            fetch(`/api/players/${playerId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.properties || data.properties.length === 0) {
                        document.getElementById('player-properties').innerHTML = 
                            '<p>This player does not own any properties.</p>';
                        return;
                    }
                    
                    const propertiesHtml = `
                        <div class="properties-grid">
                            ${data.properties.map(property => `
                                <div class="property-card" style="border-color: ${getPropertyColor(property.group)}">
                                    <h4>${property.name}</h4>
                                    <p><strong>Group:</strong> ${property.group}</p>
                                    <p><strong>Price:</strong> $${property.price}</p>
                                    <p><strong>Rent:</strong> $${property.rent}</p>
                                    <p><strong>Houses:</strong> ${property.houses || 0}</p>
                                    <p><strong>Status:</strong> ${property.is_mortgaged ? 'Mortgaged' : 'Active'}</p>
                                    <button onclick="viewPropertyDetails(${property.id})">View Details</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    document.getElementById('player-properties').innerHTML = propertiesHtml;
                })
                .catch(error => {
                    console.error('Error fetching player properties:', error);
                    document.getElementById('player-properties').innerHTML = 
                        '<p class="error">Error loading property details. Please try again.</p>';
                });
        }
        
        function viewPropertyDetails(propertyId) {
            fetch(`/api/property/${propertyId}/details`)
                .then(response => response.json())
                .then(property => {
                    const detailsHtml = `
                        <div class="property-detail-card" style="border-color: ${getPropertyColor(property.group)}">
                            <h3>${property.name}</h3>
                            <div class="property-details-grid">
                                <div class="property-detail-section">
                                    <h4>Basic Info</h4>
                                    <p><strong>Group:</strong> ${property.group}</p>
                                    <p><strong>Position:</strong> ${property.position}</p>
                                    <p><strong>Owner:</strong> ${property.owner_name || 'Bank'}</p>
                                    <p><strong>Current Price:</strong> $${property.current_price}</p>
                                    <p><strong>Mortgage Value:</strong> $${property.mortgage_value}</p>
                                    <p><strong>Status:</strong> ${property.is_mortgaged ? 'Mortgaged' : 'Active'}</p>
                                </div>
                                
                                <div class="property-detail-section">
                                    <h4>Development</h4>
                                    <p><strong>Houses:</strong> ${property.houses || 0}</p>
                                    <p><strong>Has Hotel:</strong> ${property.has_hotel ? 'Yes' : 'No'}</p>
                                    <p><strong>House Cost:</strong> $${property.house_cost || 'N/A'}</p>
                                    <p><strong>Hotel Cost:</strong> $${property.hotel_cost || 'N/A'}</p>
                                </div>
                                
                                <div class="property-detail-section">
                                    <h4>Rent Information</h4>
                                    <p><strong>Base Rent:</strong> $${property.rent}</p>
                                    <p><strong>Rent with 1 House:</strong> $${property.rent_1house || 'N/A'}</p>
                                    <p><strong>Rent with 2 Houses:</strong> $${property.rent_2house || 'N/A'}</p>
                                    <p><strong>Rent with 3 Houses:</strong> $${property.rent_3house || 'N/A'}</p>
                                    <p><strong>Rent with 4 Houses:</strong> $${property.rent_4house || 'N/A'}</p>
                                    <p><strong>Rent with Hotel:</strong> $${property.rent_hotel || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('property-details').innerHTML = detailsHtml;
                })
                .catch(error => {
                    console.error('Error fetching property details:', error);
                    document.getElementById('property-details').innerHTML = 
                        '<p class="error">Error loading property details. Please try again.</p>';
                });
        }
        
        function loadPlayerForAudit() {
            const playerId = document.getElementById('audit-player-selector').value;
            if (!playerId) {
                document.getElementById('audit-results').innerHTML = 
                    '<p>Select a player and perform an audit to see results.</p>';
                return;
            }
            
            document.getElementById('audit-results').innerHTML = 
                '<p>Player selected. Click one of the audit buttons above to perform an audit.</p>';
        }
        
        function performFullAudit() {
            const playerId = document.getElementById('audit-player-selector').value;
            if (!playerId) {
                alert('Please select a player to audit');
                return;
            }
            
            document.getElementById('audit-results').innerHTML = '<p>Running full audit, please wait...</p>';
            
            fetch(`/api/admin/players/audit/${playerId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                let resultsHtml = `
                    <div class="audit-results-card">
                        <h3>Audit Results for Player ${data.player_name}</h3>
                        
                        <div class="audit-section">
                            <h4>Financial Audit</h4>
                            <p><strong>Status:</strong> ${data.financial_audit.status}</p>
                            <p><strong>Cash Balance:</strong> $${data.financial_audit.cash_balance}</p>
                            <p><strong>Property Value:</strong> $${data.financial_audit.property_value}</p>
                            <p><strong>Debts:</strong> $${data.financial_audit.debts}</p>
                            <p><strong>Net Worth:</strong> $${data.financial_audit.net_worth}</p>
                            <p><strong>Issues:</strong> ${data.financial_audit.issues.length > 0 ? 
                                data.financial_audit.issues.join('<br>') : 'None found'}</p>
                        </div>
                        
                        <div class="audit-section">
                            <h4>Property Audit</h4>
                            <p><strong>Status:</strong> ${data.property_audit.status}</p>
                            <p><strong>Properties Owned:</strong> ${data.property_audit.properties_owned}</p>
                            <p><strong>Mortgaged Properties:</strong> ${data.property_audit.mortgaged_properties}</p>
                            <p><strong>Developed Properties:</strong> ${data.property_audit.developed_properties}</p>
                            <p><strong>Issues:</strong> ${data.property_audit.issues.length > 0 ? 
                                data.property_audit.issues.join('<br>') : 'None found'}</p>
                        </div>
                        
                        <div class="audit-section">
                            <h4>Activity Audit</h4>
                            <p><strong>Status:</strong> ${data.activity_audit.status}</p>
                            <p><strong>Transactions:</strong> ${data.activity_audit.transaction_count}</p>
                            <p><strong>Suspicious Activity:</strong> ${data.activity_audit.suspicious_activity_count}</p>
                            <p><strong>Issues:</strong> ${data.activity_audit.issues.length > 0 ? 
                                data.activity_audit.issues.join('<br>') : 'None found'}</p>
                        </div>
                        
                        <div class="audit-summary">
                            <h4>Audit Summary</h4>
                            <p><strong>Overall Status:</strong> <span class="${data.overall_status.toLowerCase()}">${data.overall_status}</span></p>
                            <p><strong>Actions Taken:</strong> ${data.actions_taken.length > 0 ? 
                                data.actions_taken.join('<br>') : 'No actions required'}</p>
                            <p><strong>Recommendations:</strong> ${data.recommendations.length > 0 ? 
                                data.recommendations.join('<br>') : 'No recommendations'}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('audit-results').innerHTML = resultsHtml;
            })
            .catch(error => {
                console.error('Error performing audit:', error);
                document.getElementById('audit-results').innerHTML = 
                    '<p class="error">Error performing audit. Please try again.</p>';
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPlayersOverview();
            
            // Set up form submission handlers
            document.getElementById('add-player-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // Code to handle adding a player
                closeModals();
            });
            
            document.getElementById('add-bot-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // Code to handle adding a bot
                closeModals();
            });
            
            document.getElementById('modify-cash-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const playerId = document.getElementById('modify-cash-player-id').value;
                const amount = document.getElementById('modify-cash-amount').value;
                const reason = document.getElementById('modify-cash-reason').value || 'Admin adjustment';
                
                fetch('/api/admin/players/modify-cash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_id: playerId,
                        amount: parseInt(amount),
                        reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Player cash modified successfully');
                        loadPlayersOverview();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error modifying cash:', error);
                    alert('Error modifying cash. Please try again.');
                });
                
                closeModals();
            });
            
            document.getElementById('transfer-property-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // Code to handle property transfer
                closeModals();
            });
            
            document.getElementById('remove-player-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const playerId = document.getElementById('remove-player-id').value;
                const handleProperties = document.getElementById('remove-player-handle-properties').value;
                const reason = document.getElementById('remove-player-reason').value || 'Admin removal';
                
                fetch('/api/admin/players/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_id: playerId,
                        handle_properties: handleProperties,
                        reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Player removed successfully');
                        loadPlayersOverview();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error removing player:', error);
                    alert('Error removing player. Please try again.');
                });
                
                closeModals();
            });
        });
    </script>
</body>
</html> 